<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="preload" href="/img/background.jpg" as="image">
    
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                tags: 'ams'
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    console.log('MathJax 3 loaded and initialized');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const images = document.querySelectorAll('.post-content img');
            images.forEach(img => {
                img.loading = 'lazy';
                
                img.classList.add('fade-in-image');
                img.onload = () => img.classList.add('loaded');

                img.onerror = function() {
                    console.warn('Image failed to load:', img.src);
                    
                    if (this.dataset.triedFallback === 'true') {
                        this.alt = 'Image not found: ' + (this.src.split('/').pop());
                        this.style.display = 'none';
                        const errorMsg = document.createElement('span');
                        errorMsg.style.color = 'red';
                        errorMsg.style.fontSize = '0.8em';
                        errorMsg.innerText = '[Image Load Failed]';
                        this.parentNode.insertBefore(errorMsg, this.nextSibling);
                        return;
                    }
                    this.dataset.triedFallback = 'true';
                    const filename = this.src.split('/').pop();
                    if (filename) {
                        const newSrc = '/img/' + filename;
                        console.log('Attempting fallback to:', newSrc);
                        this.src = newSrc;
                    }
                };
            });

            const bgImage = new Image();
            bgImage.src = '/img/background.jpg'; 
            bgImage.onload = function() {
                document.body.classList.add('bg-loaded');
            };

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        console.log('SW registered: ', registration);
                    }).catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
                });
            }

            // Performance Monitoring
            if ('PerformanceObserver' in window) {
                try {
                    new PerformanceObserver((entryList) => {
                        for (const entry of entryList.getEntries()) {
                            console.log('LCP:', entry.startTime, entry);
                        }
                    }).observe({type: 'largest-contentful-paint', buffered: true});

                    new PerformanceObserver((entryList) => {
                        for (const entry of entryList.getEntries()) {
                            if (!entry.hadRecentInput) {
                                console.log('CLS Shift:', entry.value, entry);
                            }
                        }
                    }).observe({type: 'layout-shift', buffered: true});
                } catch (e) {
                    console.warn('PerformanceObserver not supported.');
                }
            }
        });
    </script>
    <style>
        .fade-in-image {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .fade-in-image.loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Optimized Background Image -->
    <div id="bg-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden;">
        <picture>
            <source srcset="/img/background.avif" type="image/avif">
            <source srcset="/img/background.webp" type="image/webp">
            <img src="/img/background.jpg" id="bg-image" alt="Background" width="1920" height="1080" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s ease-in-out;">
        </picture>
    </div>

    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <div class="container blog-container post-page-container">
        <img src="/img/nuo534202.jpg" class="avatar" alt="nuo534202">
        <h1>{{ page.title }}</h1>
        <p class="subtitle">{{ page.date | date: "%Y-%m-%d" }}</p>
        <div class="decorative-line"></div>
        
        <div class="post-content">
            {{ content }}
        </div>

        <div class="nav-links" style="margin-top: 30px;">
            <a href="/blog/competitive_programming/index.html" class="btn">
                <span class="btn-icon">↩️</span>
                Back to Competitive Programming
            </a>
        </div>
        
        <p class="footer">Code is poetry</p>
    </div>
</body>
</html>